{% extends 'base.html' %}
{% block content %}
  <h2>Dashboard</h2>
  <p>Welcome, {{ user.username }}.</p>
  <div>
    <h3>Your recent quiz attempts</h3>
    {% if attempts %}
      <ul>
        {% for a in attempts %}
          <li>{{ a.quiz.title }} — {{ a.score }}% ({{ a.taken_at }})</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No quiz attempts yet.</p>
    {% endif %}
  </div>

  <div>
    <h3>Quiz performance (recent)</h3>
    <canvas id="scoresChart" width="600" height="200"></canvas>
  </div>

  <div>
    <h3>Completed training modules</h3>
    {% if progress %}
      <ul>
        {% for p in progress %}
          <li>{{ p.module.title }} — completed {{ p.completed_at }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No completed modules yet.</p>
    {% endif %}
  </div>

  <ul>
    <li><a href="/training/">Training Modules</a></li>
    <li><a href="/quizzes/">Take a Quiz</a></li>
    <li><a href="/case-studies/">Read Case Studies</a></li>
  </ul>
{% endblock %}

{% block scripts %}
  <script id="attempts-data" type="application/json">{{ attempts_json|safe }}</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const attemptsData = JSON.parse(document.getElementById('attempts-data').textContent || '[]');
    const dataLabels = attemptsData.map(a => a.taken_at);
    const dataScores = attemptsData.map(a => a.score);
    const ctx = document.getElementById('scoresChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: dataLabels,
        datasets: [{
          label: 'Score %',
          data: dataScores,
          fill: false,
          borderColor: 'rgb(75, 192, 192)'
        }]
      },
      options: { responsive: true }
    });
  </script>
{% endblock %}
